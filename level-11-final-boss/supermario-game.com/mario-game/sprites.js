function resetCanvas(){window.canvas=getCanvas(innerWidth,innerHeight,!0),window.context=canvas.getContext("2d"),body.appendChild(canvas)}function spriteUnravel(colors){for(var current,rep,nixloc,paletteref=getPaletteReferenceStarting(window.palette),digitsize=window.digitsize,clength=colors.length,output="",loc=0;loc<clength;)switch(colors[loc]){case"x":for(nixloc=colors.indexOf(",",++loc),current=makeDigit(paletteref[colors.slice(loc,loc+=digitsize)],window.digitsize),rep=Number(colors.slice(loc,nixloc));rep--;)output+=current;loc=nixloc+1;break;case"p":"["==colors[++loc]?(nixloc=colors.indexOf("]"),paletteref=getPaletteReference(colors.slice(loc+1,nixloc).split(",")),loc=nixloc+1,digitsize=1):(paletteref=getPaletteReference(window.palette),digitsize=window.digitsize);break;default:output+=makeDigit(paletteref[colors.slice(loc,loc+=digitsize)],window.digitsize)}return output}function spriteExpand(colors){for(var current,j,output="",clength=colors.length,i=0;i<clength;)for(current=colors.slice(i,i+=digitsize),j=0;j<scale;++j)output+=current;return output}function spriteGetArray(colors){var reference,i,j,k,numcolors=colors.length/digitsize,split=colors.match(new RegExp(".{1,"+digitsize+"}","g")),output=new Uint8ClampedArray(4*numcolors);for(i=0,j=0;i<numcolors;++i){for(reference=palette[Number(split[i])],k=0;k<4;++k)output[j+k]=reference[k];j+=4}return output}function setThingSprite(thing){if(!thing.hidden&&thing.title){var sprite,cache=library.cache,width=thing.spritewidth,height=thing.spriteheight;cache[thing.title+" "+thing.className.split(/\s+/g).slice(1).sort()];(sprite=getSpriteFromLibrary(thing))?sprite.multiple?(expandObtainedSpriteMultiple(sprite,thing,width,height),thing.sprite_type=sprite.type):(expandObtainedSprite(sprite,thing,width,height),thing.sprite_type="normal"):log("Could not get sprite from library on "+thing.title)}}function getSpriteFromLibrary(thing){var key,cached,sprite,i,cache=library.cache,title=thing.title,libtype=thing.libtype,classes=thing.className.split(/\s+/g).slice(1).sort(),setting=(map.area||window.defaultsetting).setting.split(" ");for(i in setting)classes.unshift(setting[i]);if(cached=cache[key=title+" "+classes])sprite=cached.raw;else{if(!(sprite=library.sprites[libtype][title])||!sprite.constructor)return console.log("Error in checking for sprite of "+title+"."),void console.log("Title "+title,"\nLibtype "+libtype,"\n",thing,"\n");sprite.constructor!=Uint8ClampedArray&&(sprite=findSpriteInLibrary(thing,sprite,classes)),cached=cache[key]={raw:sprite}}switch(String(Number(classes.indexOf("flipped")>=0))+String(Number(classes.indexOf("flip-vert")>=0))){case"11":sprite=cached.flipboth?cached.flipboth:cached.flipboth=flipSpriteArrayBoth(sprite);break;case"10":sprite=cached.fliphoriz?cached.fliphoriz:cached.fliphoriz=flipSpriteArrayHoriz(sprite,thing);break;case"01":sprite=cached.flipvert?cached.flipvert:cached.flipvert=flipSpriteArrayVert(sprite,thing);break;default:sprite=cached.raw}return sprite}function expandObtainedSprite(sprite,thing,width,height,norefill){var si,sj,parsed=new Uint8ClampedArray(sprite.length*scale),rowsize=width*unitsizet4,heightscale=height*scale,readloc=0,writeloc=0;for(si=0;si<heightscale;++si){for(sj=0;sj<scale;++sj)memcpyU8(sprite,parsed,readloc,writeloc,rowsize),writeloc+=rowsize;readloc+=rowsize}return norefill||(thing.num_sprites=1,thing.sprite=parsed,refillThingCanvas(thing)),parsed}function expandObtainedSpriteMultiple(sprites,thing,width,height){var sprite,part,parsed={};for(part in thing.num_sprites=0,sprites)(sprite=sprites[part]).constructor==Uint8ClampedArray?(++thing.num_sprites,parsed[part]=expandObtainedSprite(sprite,thing,width,height,!0)):parsed[part]="number"==typeof sprite?sprite*scale:sprite;thing.sprite=parsed.middle,thing.sprites=parsed,refillThingCanvases(thing,parsed)}function findSpriteInLibrary(thing,current,classes){var nogood,check,i,prev=current;if(current.multiple)return current;for(var loop_num=0;nogood=!0;){for(i in++loop_num>49&&(alert(thing.title),console.log(thing.title,classes,current)),classes)if(check=current[classes[i]]){current=check,classes.splice(i,1),nogood=!1;break}if(nogood)if(check=current.normal)switch(nogood=!1,check.constructor){case Uint8ClampedArray:case SpriteMultiple:return check;case Object:current=check;break;default:current=current[check]}else nogood=!0;if(nogood||!current)return console.log("\nSprite not found! Title: "+thing.title),console.log("Classname:",thing.className),console.log("Remaining",classes),console.log("Current",current),console.log("Prev",prev),new Uint8ClampedArray(thing.spritewidth*thing.spriteheight);switch(current.constructor){case Uint8ClampedArray:case SpriteMultiple:return current;case"Object":continue}}}function refillThingCanvas(thing){var canvas=thing.canvas,context=thing.context,imageData=context.getImageData(0,0,canvas.width,canvas.height);memcpyU8(thing.sprite,imageData.data),context.putImageData(imageData,0,0)}function refillThingCanvases(thing,parsed){var part,imageData,canvas,context,i,canvases=thing.canvases={},width=thing.spritewidthpixels,height=thing.spriteheightpixels;for(i in thing.num_sprites=1,parsed)(part=parsed[i])instanceof Uint8ClampedArray?(++thing.num_sprites,canvases[i]=canvas={canvas:getCanvas(width,height)},canvas.context=context=canvas.canvas.getContext("2d"),memcpyU8(part,(imageData=context.getImageData(0,0,width,height)).data),context.putImageData(imageData,0,0)):canvases[i]=part;canvas=canvases.middle,thing.canvas=canvas.canvas,thing.context=canvas.context}function refillCanvas(){var i,canvas=window.canvas,context=window.context;for(context.fillStyle=area.fillStyle,context.fillRect(0,0,canvas.width,canvas.height),i=scenery.length-1;i>=0;--i)drawThingOnCanvas(context,scenery[i]);for(i=solids.length-1;i>=0;--i)drawThingOnCanvas(context,solids[i]);for(i=characters.length-1;i>=0;--i)drawThingOnCanvas(context,characters[i])}function drawThingOnCanvas(context,me){if(!me.hidden){var leftc=me.left,topc=me.top;leftc>innerWidth||(1==me.num_sprites?drawThingOnCanvasSingle(context,me.canvas,me,leftc,topc):drawThingOnCanvasMultiple(context,me.canvases,me.canvas,me,leftc,topc))}}function drawThingOnCanvasSingle(context,canvas,me,leftc,topc){me.repeat?drawPatternOnCanvas(context,canvas,leftc,topc,me.unitwidth,me.unitheight):context.drawImage(canvas,leftc,topc)}function drawThingOnCanvasMultiple(context,canvases,canvas,me,leftc,topc){var sdiff,canvasref,topreal=topc,leftreal=leftc,rightreal=me.right,bottomreal=me.bottom,widthreal=me.unitwidth,heightreal=me.unitheight,spritewidthpixels=me.spritewidthpixels,spriteheightpixels=me.spriteheightpixels;"v"==me.sprite_type[0]?((canvasref=canvases.bottom)&&(sdiff=canvases.bottomheight||me.spriteheightpixels,drawPatternOnCanvas(context,canvasref.canvas,leftreal,bottomreal-sdiff,spritewidthpixels,min(heightreal,spriteheightpixels)),bottomreal-=sdiff,heightreal-=sdiff),(canvasref=canvases.top)&&(sdiff=canvases.topheight||me.spriteheightpixels,drawPatternOnCanvas(context,canvasref.canvas,leftreal,topreal,spritewidthpixels,min(heightreal,spriteheightpixels)),topreal+=sdiff,heightreal-=sdiff)):"h"==me.sprite_type[0]&&((canvasref=canvases.left)&&(sdiff=canvases.leftwidth||me.spritewidthpixels,drawPatternOnCanvas(context,canvasref.canvas,leftreal,topreal,min(widthreal,spritewidthpixels),spriteheightpixels),leftreal+=sdiff,widthreal-=sdiff),(canvasref=canvases.right)&&(sdiff=canvases.rightwidth||me.spritewidthpixels,drawPatternOnCanvas(context,canvasref.canvas,rightreal-sdiff,topreal,min(widthreal,spritewidthpixels),spriteheightpixels),rightreal-=sdiff,widthreal-=sdiff)),topreal<bottomreal&&leftreal<rightreal&&drawPatternOnCanvas(context,canvas,leftreal,topreal,widthreal,heightreal)}function getPaletteReferenceStarting(palette){for(var output={},i=0;i<palette.length;++i)output[makeDigit(i,digitsize)]=makeDigit(i,digitsize);return output}function getPaletteReference(palette){for(var output={},digitsize=getDigitSize(palette),i=0;i<palette.length;++i)output[makeDigit(i,digitsize)]=makeDigit(palette[i],digitsize);return output}function flipSpriteArrayHoriz(sprite,thing){var newloc,oldloc,i,j,k,length=sprite.length,width=thing.spritewidth,newsprite=(thing.spriteheight,new Uint8ClampedArray(length)),rowsize=width*unitsizet4;for(i=0;i<length;i+=rowsize)for(newloc=i,oldloc=i+rowsize-4,j=0;j<rowsize;j+=4){for(k=0;k<4;++k)newsprite[newloc+k]=sprite[oldloc+k];newloc+=4,oldloc-=4}return newsprite}function flipSpriteArrayVert(sprite,thing){for(var i,j,length=sprite.length,width=thing.spritewidth,newsprite=(thing.spriteheight,new Uint8ClampedArray(length)),rowsize=width*unitsizet4,newloc=0,oldloc=length-rowsize;newloc<length;){for(i=0;i<rowsize;i+=4)for(j=0;j<4;++j)newsprite[newloc+i+j]=sprite[oldloc+i+j];newloc+=rowsize,oldloc-=rowsize}return newsprite}function flipSpriteArrayBoth(sprite){for(var i,length=sprite.length,newsprite=new Uint8ClampedArray(length),oldloc=sprite.length-4,newloc=0;newloc<length;){for(i=0;i<4;++i)newsprite[newloc+i]=sprite[oldloc+i];newloc+=4,oldloc-=4}return newsprite}function drawPatternOnCanvas(context,source,leftc,topc,unitwidth,unitheight){context.translate(leftc,topc),context.fillStyle=context.createPattern(source,"repeat"),context.fillRect(0,0,unitwidth,unitheight),context.translate(-leftc,-topc)}function clearAllSprites(clearcache){var arr,i,arrs=[window.solids,window.characters,window.scenery];for(arr in arrs)for(i in arr=arrs[arr])setThingSprite(arr[i]);clearcache&&(library.cache={})}function memcpyU8(source,destination,readloc,writeloc,writelength){if(!(!source||!destination||readloc<0||writeloc<0||writelength<=0||readloc>=source.length||writeloc>=destination.length)){null==readloc&&(readloc=0),null==writeloc&&(writeloc=0),null==writelength&&(writelength=max(0,min(source.length,destination.length)));for(var lwritelength=writelength+0,lwriteloc=writeloc+0,lreadloc=readloc+0;lwritelength--;)destination[lwriteloc++]=source[lreadloc++]}}function canvasDisableSmoothing(canvas,context){(context=context||canvas.getContext("2d")).webkitImageSmoothingEnabled=!1,context.mozImageSmoothingEnabled=!1,context.imageSmoothingEnabled=!1}