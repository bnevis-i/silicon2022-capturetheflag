function upkeep(){if(!window.paused){window.nextupk=setTimeout(upkeep,timer);for(var i=window.speed;i>0;--i)adjustFPS(),QuadsKeeper.determineAllQuadrants(solids),maintainSolids(),maintainCharacters(),maintainPlayer(),texts.length&&maintainTexts(),TimeHandler.handleEvents(),refillCanvas()}}function adjustFPS(){window.time_now=now();var time_diff=time_now-time_prev,fps_actual=roundDigit(1e3/time_diff,.001);window.fps=roundDigit(.7*fps+.3*fps_actual,.01),window.realtime=fps_target/fps,window.time_prev=time_now}function pause(big){paused&&!window.nextupk||(cancelAnimationFrame(nextupk),AudioPlayer.pause(),paused=!0,big&&AudioPlayer.play("Pause"))}function unpause(){paused&&(window.nextupk=requestAnimationFrame(upkeep),paused=!1,AudioPlayer.resume())}function maintainSolids(update){for(var solid,i=0;i<solids.length;++i)(solid=solids[i]).alive&&solid.movement&&solid.movement(solid),(!solid.alive||solid.right<QuadsKeeper.getDelX())&&deleteThing(solid,solids,i)}function maintainCharacters(update){var character,i,delx=gamescreen.right+QuadsKeeper.getOutDifference();for(i=0;i<characters.length;++i)(character=characters[i]).resting?character.yvel=0:(character.nofall||(character.yvel+=character.gravity||map.gravity),character.yvel=min(character.yvel,map.maxyvel)),updatePosition(character),QuadsKeeper.determineThingQuadrants(character),character.under=character.undermid=!1,determineThingCollisions(character),character.resting&&(characterOnResting(character,character.resting)?(character.yvel=!1,setBottom(character,character.resting.top)):character.resting=!1),character.alive?"player"==character.type||map.shifting||!(0==character.numquads||character.left>delx)||character.outerok?!character.nomove&&character.movement&&character.movement(character):deleteThing(character,characters,i):map.shifting||deleteThing(character,characters,i)}function maintainPlayer(update){if(player.alive){if(player.yvel>0&&(map.underwater||(player.keys.jump=0),player.jumping||(map.underwater?player.paddling||(switchClass(player,"paddling","paddling"),player.padding=!0):(addClass(player,"jumping"),player.jumping=!0)),!player.piping&&!player.dying&&player.top>gamescreen.deathheight)){if(map.exitloc)return map.random?(goToTransport(["Random","Overworld","Down"]),void playerDropsIn()):shiftToLocation(map.exitloc);clearPlayerStats(),killPlayer(player,2)}player.xvel>0?player.right>gamescreen.middlex&&player.right>gamescreen.right-gamescreen.left&&(player.xvel=min(0,player.xvel)):player.left<0&&(player.xvel=max(0,player.xvel)),player.under&&(player.jumpcount=0),window.scrolloffset=map.canscroll*(player.right-gamescreen.middlex),scrolloffset>0&&!map.shifting?scrollWindow(lastscroll=round(min(player.scrollspeed,scrolloffset))):lastscroll=0}}function maintainTexts(){var element,me,i;for(i=texts.length-1;i>=0;--i)element=(me=texts[i]).element||me,me.xvel&&elementShiftLeft(element,me.xvel),me.yvel&&elementShiftTop(element,me.yvel)}