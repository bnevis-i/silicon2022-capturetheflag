function resetTriggers(){window.controls=new Controls({left:[37,65,"AXIS_LEFT","DPAD_LEFT"],right:[39,68,"AXIS_RIGHT","DPAD_RIGHT"],up:[38,87,32,"FACE_1","DPAD_UP","LEFT_BOTTOM_SHOULDER"],down:[40,83,"AXIS_DOWN","DPAD_DOWN"],sprint:[16,17,"FACE_1"],pause:[80,"START_FORWARD"],mute:[77],q:[81],l:[76]}),window.gamepad=new Gamepad,gamepad.bind(Gamepad.Event.BUTTON_DOWN,ControlsPipe("keydown",!0)),gamepad.bind(Gamepad.Event.BUTTON_UP,ControlsPipe("keyup",!1)),gamepad.bind(Gamepad.Event.AXIS_CHANGED,(function(event){var value=event.value,value_abs=abs(value);if(!(value_abs<.1))switch(event.axis){case"LEFT_STICK_Y":case"RIGHT_STICK_Y":value_abs>.5?keydown(value>0?"DPAD_DOWN":"DPAD_UP"):(keyup("DPAD_UP"),keyup("DPAD_DOWN"));break;case"LEFT_STICK_X":case"RIGHT_STICK_X":value_abs>.5?keydown(value<0?"DPAD_LEFT":"DPAD_RIGHT"):(keyup("DPAD_UP"),keyup("DPAD_DOWN"))}})),gamepad.init(),proliferate(body,{onkeydown:ControlsPipe("keydown",!0),onkeyup:ControlsPipe("keyup",!1),oncontextmenu:contextmenu,onmousedown:mousedown}),setMessageTriggers()}function Controls(pipes,gamepadPipes){this.pipes=pipes;var tag,codes,code,i,keydown=this.keydown={left:function(keys){keys.run=-1,keys.left_down=!0},right:function(keys){keys.run=1,keys.right_down=!0},up:function(keys){keys.up=!0,player.canjump&&(player.resting||map.underwater)&&(keys.jump=1,player.canjump=keys.jumplev=0,AudioPlayer.play(player.power>1?"Jump Super":"Jump Small"),map.underwater&&setTimeout((function(){player.jumping=keys.jump=!1}),14*timer))},down:function(keys){keys.crouch=!0},sprint:function(keys){3!=player.power||0!=keys.sprint||keys.crouch||player.fire(),keys.sprint=1},pause:function(keys){paused||window.editing&&!editor.playing||setTimeout((function(){pause(!0)}),140)},mute:function(keys){AudioPlayer.toggleMute()},q:function(keys){switch(++qcount>28&&maxlulz(),qcount){case 7:lulz();break;case 14:superlulz();break;case 21:hyperlulz()}},l:function(keys){toggleLuigi()}},keyup=this.keyup={left:function(keys){keys.run=0,keys.left_down=!1},right:function(keys){keys.run=0,keys.right_down=!1},up:function(keys){map.underwater||(keys.jump=keys.up=0),player.canjump=!0},down:function(keys){keys.crouch=0,removeCrouch()},sprint:function(keys){keys.sprint=0},pause:function(keys){unpause(!0)}};for(tag in pipes)for(i in codes=pipes[tag])keydown[code=codes[i]]=keydown[tag],keyup[code]=keyup[tag]}function ControlsPipe(name,strict){var responses=controls[name];return function(event){strict&&(player&&player.dead||window.paused)||window.nokeys||(("number"!=typeof event||event.which||event.control)&&(event=event.which||event.control),responses[event]?responses[event](player.keys):mlog(name,"Could not",name,event),window.gamehistory[gamecount]=[keydown,event])}}function keydown(event){if(!(player&&player.dead||window.paused||window.nokeys)){var responses=controls.keydown;("object"==typeof event||event.which)&&(event=event.which),responses[event]&&responses[event](player.keys),window.gamehistory[gamecount]=[keydown,event]}}function keyup(event){if(!window.nokeys){var responses=controls.keyup;("object"==typeof event||event.which)&&(event=event.which),responses[event]&&responses[event](player.keys),window.gamehistory[gamecount]=[keyup,event]}}function contextmenu(event){event.preventDefault&&event.preventDefault()}function mousedown(event){3==event.which&&(paused?unpause():window.editor&&(editing||editor.playing)||pause(!0),event.preventDefault&&event.preventDefault())}function scriptKeys(oldhistory){var i,entry;for(i in oldhistory)entry=oldhistory[i],TimeHandler.addEvent(entry[0],i,entry[1]),TimeHandler.addEvent((function(){alert(entry[0].name+", "+entry[1])}),i)}function lulz(options,timer){player.star=!0,options=options||[Goomba],timer=timer||7,TimeHandler.addEventInterval((function(){if(!(characters.length>210)){var lul=new Thing(options[randInt(options.length)],randBoolJS(),randBoolJS());lul.yvel=random()*-unitsizet4,lul.xvel=lul.speed=random()*unitsizet2*randSign(),addThing(lul,(32*random()+128)*unitsize,88*random()*unitsize)}}),timer,1/0)}function superlulz(){lulz([Goomba,Koopa,Beetle,HammerBro,Lakitu,Podoboo,Blooper])}function hyperlulz(){lulz([Bowser],21)}function maxlulz(){TimeHandler.addEventInterval((function(arr){setAreaSetting(arr[randInt(arr.length)])}),7,1/0,["Overworld","Underworld","Underwater","Sky","Castle"])}function mapKeyToControl(action,keyCode){if(-1==window.controls.pipes[action].indexOf(keyCode)){window.controls.pipes[action].push(keyCode);var newPipes=window.controls.pipes;window.controls=new Controls(newPipes),proliferate(body,{onkeydown:ControlsPipe("keydown",!0),onkeyup:ControlsPipe("keyup",!1),oncontextmenu:contextmenu,onmousedown:mousedown})}}function setMessageTriggers(){var command_codes={setMap:triggerSetMap,startEditor:function(){loadEditor()},toggleOption:function(data){var name="toggle"+data.option;console.log(name,window[name]),window[name]?window[name]():log("Could not toggle",name)},setKey:function(data){mapKeyToControl(data.action,data.keyCode)}};window.addEventListener("message",(function(event){var data=event.data,type=data.type;command_codes[type]?command_codes[type](data):console.log("Unknown event type received:",type,".\n",data)}))}function triggerSetMap(data){clearPlayerStats(),setMap.apply(this,data.map||[]),setLives(3)}